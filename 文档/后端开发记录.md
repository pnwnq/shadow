# 后端开发记录

本文档记录了 Shadow 实验室管理系统后端开发的关键节点和决策。

## 角色系统（进行中）

此阶段的目标是建立一个稳定、安全且可扩展的用户角色与权限系统，并完成与前端的初步对接。

### 已完成的工作

1.  **数据库迁移与云端部署**

    - 项目数据库已成功从本地迁移至 Sealos 云平台上的 PostgreSQL 实例。
    - 通过 `prisma migrate` 解决了数据库环境同步和表结构漂移（Drift）的问题，确保了云端数据库结构与 `schema.prisma` 定义一致。

2.  **核心认证流程修复**

    - **注册功能**：创建了 `/api/auth/register` API 路由，实现了完整的用户注册逻辑，包括使用 `bcryptjs` 进行密码加密。
    - **登录功能**：配置了 `next-auth` 的 `CredentialsProvider`，允许用户通过邮箱和密码登录。
    - **GitHub 登录**：初步配置了 `GithubProvider`，为后续提供 OAuth 登录方式奠定了基础。
    - **数据库连接池**：通过创建单例的 Prisma Client (`lib/prisma.ts`)，解决了因开发环境热重载导致的数据库连接耗尽问题。

3.  **前端集成与数据真实化**

    - **解决了 Hydration Mismatch**：通过在根布局添加 `suppressHydrationWarning`，修复了由 `next-themes` 引起的客户端与服务器渲染不匹配的问题。
    - **实现了真实用户导航**：重构了 `<UserNav />` 组件，使用 `next-auth/react` 的 `useSession` Hook 从会话中获取真实的用户名、邮箱和角色，替换了所有硬编码的假数据。
    - **全局 Session 支持**：通过创建 `<AuthProvider />` 并将其添加到根布局，解决了 `useSession must be wrapped in a <SessionProvider />` 的错误，使会话信息在整个应用中可用。
    - **统一了类型定义**：创建了 `types/next-auth.d.ts` 类型声明文件，扩展了 `next-auth` 的默认类型，将 `role` 和 `status` 等自定义字段注入到 Session 和 User 对象中，根除了反复出现的类型错误。

4.  **权限边界划分 (V1)**
    - 在 `lib/auth-utils.ts` 中调整了权限映射关系，移除了 `ADMIN` 角色的 `system_settings` 权限。
    - 实现了只有 `SUPER_ADMIN` 角色的用户才能在导航栏中看到"管理中心"入口，普通 `ADMIN` 及以下角色将看不到此入口。

### 后续计划与待办事项

1.  **多角色登录验证**

    - **目标**：确保每个预设的角色（`SUPER_ADMIN`, `ADMIN`, `MEMBER`, `COMPETITION_ACCOUNTANT`）都能正确登录，并且其前端视图（特别是导航栏）符合权限预期。
    - **执行**：需要创建至少 4 个测试账户，分别对应上述四个角色，并逐一登录检查。

2.  **导航栏权限细化 (`MainNav`)**

    - **目标**：当前的导航栏（物品管理、财务、竞赛等）对所有登录用户都是可见的。需要根据 `lib/auth-utils.ts` 中定义的权限，动态地向不同用户展示他们有权访问的导航链接。
    - **执行**：修改 `<MainNav />` 组件，在渲染每个导航链接前，调用 `currentUserHasPermission` 函数进行权限检查。

3.  **首页仪表盘数据真实化 (`/home`)**

    - **目标**：将 `/home` 页面上当前写死的统计数据（如文档数量、项目数量、最近活动等）替换为从数据库查询的真实数据。
    - **执行**：
      - 在 `/home/page.tsx`（服务器组件）中，使用 Prisma 查询数据库，获取所需的数据。
      - 将查询到的真实数据作为 props 传递给 `/home/home-client.tsx` 客户端组件进行渲染。

4.  **完善个人资料页面 (`/profile`)**
    - **目标**：允许用户查看和编辑自己的个人信息（如姓名、专业等）。
    - **执行**：
      - 创建用于更新用户信息的 API 路由。
      - 在 `/profile` 页面上添加一个表单，允许用户提交修改。
