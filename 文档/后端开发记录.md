# 后端开发记录

本文档简要记录了 Shadow 实验室管理系统后端开发的关键节点。

## 历史归档

- **V0.1 -> V0.2: 核心重构与现代化升级**
  - 对整个项目进行了大规模重构，移除了遗留的、不安全的前端权限系统。
  - 将认证系统从 `next-auth` v4 全面升级至 v5 (`Auth.js`)，以适配 Next.js App Router，并解决了所有相关的安全漏洞和技术债务。

## 当前工作：文档管理系统功能完善

- **目标**: 在完成核心重构的基础上，为文档管理模块添加核心 CRUD 功能。
- **已完成**:
  - **文件删除**: 实现了从前端发起，后端执行的完整删除流程，同步删除 Vercel Blob 存储中的文件和数据库中的元数据记录。
- **后续计划**:
  - **详情页功能完善**: 完成文档预览、版本历史等核心功能。
  - **列表功能增强**: 为文档列表页添加多维度筛选（如分类、标签）和排序功能。
  - **代码结构重构**: 整合分散在不同目录下的收藏、共享等相关逻辑，优化代码结构。

## 新功能：AI 问答助手 (初步完成)

- **功能目标**: 引入大语言模型，为实验室提供一个智能问答助手，解答关于实验室信息、设备使用、项目资料等常见问题。
- **技术选型**:
  - **前端**: 使用 `Vercel AI SDK` 的 `useChat` hook 和 `shadcn/ui` 构建交互界面。
  - **后端**: 使用智谱 AI (GLM-4) 作为模型提供方，通过其官方 Node.js SDK 调用。
- **核心挑战与实现**:
  - **流式响应适配**: 解决了智谱 AI SDK 返回的原始 SSE（服务器发送事件）流与 Vercel AI SDK v3 的 `Data Stream Protocol` 之间格式不匹配的根本问题。这是本次开发最核心的攻坚任务。
  - **后端流转换**: 在 Next.js API Route (`/api/ai/chat`) 中，手动实现了对原始 SSE 二进制流的解码、按行解析、过滤 `[DONE]` 结束信号和重新封装，使其完全符合前端 `useChat` hook 的解析要求。
  - **环境配置**: 解决了因依赖库 (`jsonwebtoken`) 需要 `crypto` 模块而必须将 API 路由的运行环境从默认的 `Edge` 切换到 `Node.js` 的问题。
  - **前端调试**: 修复了因组件导入/导出方式不一致、`useChat` API 路径错误等问题导致的多个前端渲染和通信故障。
- **状态**: 初步完成。前后端已联调成功，实现了基本的流式问答功能。
