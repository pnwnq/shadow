# 后端开发记录

本文档记录了 Shadow 实验室管理系统后端开发的关键节点和决策。

## 文档管理系统 (功能开发中)

此阶段的核心目标是为系统构建一个全新的、独立且功能完善的文档管理模块。我们采用了成熟的开源库与云服务相结合的方案，以确保用户体验和系统的可扩展性。

### 核心技术栈

- **前端 UI**: 使用 **Uppy** 库（`@uppy/react`），提供了一个功能丰富的拖拽上传仪表盘。
- **文件存储**: 使用 **Vercel Blob** 服务，作为高可用的云端对象存储。
- **元数据管理**: 所有文件的元数据（如文件名、URL、上传者等）存储在项目的 **PostgreSQL** 数据库中，通过 **Prisma** 进行管理。
- **文档预览**: PDF 预览采用 `react-pdf` 库；Office 文档预览采用 Microsoft Office Web Viewer。

### 已完成的工作

1.  **数据库与 API 搭建**

    - **数据模型**: 在 `prisma/schema.prisma` 中新增了 `Document` 模型，并建立了与 `User` 模型的关联。
    - **后端接口**: 创建了 `/api/upload` 路由，负责处理文件上传。该接口能验证用户会话、解析 `multipart/form-data` 请求、将文件流存入 Vercel Blob，并最终将文件元数据写入数据库。

2.  **端到端流程打通 (本地 & 云端)**

    - **本地环境**: 解决了 `pnpm` 与 Prisma 的集成问题，补全了 Uppy 的所有对等依赖，并配置了 `.env.local` 使本地开发环境能成功上传文件。
    - **云端部署**: 打通了从 `git push` 到触发 Vercel 自动部署的 CI/CD 流程。
    - **构建错误修复**: 通过在 `package.json` 中为 `build` 命令添加 `prisma generate`，解决了 Vercel 缓存导致的 Prisma Client 初始化失败问题，应用已能成功部署。
    - **服务关联**: 成功将 Vercel 项目、Vercel Blob 存储服务关联，并获取了 `BLOB_READ_WRITE_TOKEN` 完成了本地开发授权。

3.  **初步功能实现**

    - **上传页面**: 创建了 `/documents/upload` 页面，集成了 Uppy `Dashboard` 组件，并实现了组件的中文化。
    - **文件列表**: 创建了 `/documents` 主页面，用于展示所有已上传的文件列表。
    - **详情页面**: 创建了 `/documents/[id]` 详情页面（目前为静态数据）。

### 当前状态与后续计划

- **当前状态**: 核心的文档上传、存储、列表展示流程已全部打通，应用可被成功部署。我们已从环境配置与调试阶段，正式进入功能迭代开发阶段。

- **后续计划**:
  1.  **实现文档预览功能**:
      - **目标**: 在文档详情页为 PDF、Office 文档及图片等提供在线预览。
      - **执行**: 创建一个可重用的 `DocumentPreview` 组件，根据文件类型调用 `react-pdf`（已安装）或 Microsoft Office Web Viewer 来渲染文件。
      - **状态**: **进行中**。
  2.  **整合增强版上传页面**:
      - **目标**: 用一个包含文件标题、分类、描述等丰富表单的自定义上传页面，替换当前简单的 Uppy 上传页。
      - **执行**:
        - 将 `UploadFilePage` 的 UI 整合到 `/documents/upload` 页面。
        - 修改后端 API 和数据库模型，以支持存储这些新增的元数据字段。
  3.  **详情页功能真实化**:
      - **目标**: 将文档详情页所有功能（如评论、收藏、分享、版本历史、AI 问答）与后端真实数据对接。
      - **执行**: 逐个为这些功能创建对应的 API 路由和数据库操作。

---

## 角色系统（已归档）

此阶段的目标是建立一个稳定、安全且可扩展的用户角色与权限系统，并完成与前端的初步对接... (细节已省略)
