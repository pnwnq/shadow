# 后端开发记录

本文档记录了 Shadow 实验室管理系统后端开发的关键节点和决策。

## 文档管理系统 (进行中)

此阶段的核心目标是为系统构建一个全新的、独立且功能完善的文档管理模块。我们采用了成熟的开源库与云服务相结合的方案，以确保用户体验和系统的可扩展性。

### 核心技术栈

- **前端 UI**: 使用 **Uppy** 库（`@uppy/react`），提供了一个功能丰富的拖拽上传仪表盘。
- **文件存储**: 使用 **Vercel Blob** 服务，作为高可用的云端对象存储。
- **元数据管理**: 所有文件的元数据（如文件名、URL、上传者等）存储在项目的 **PostgreSQL** 数据库中，通过 **Prisma** 进行管理。

### 已完成的工作

1.  **数据库与 API 搭建**

    - **数据模型**: 在 `prisma/schema.prisma` 中新增了 `Document` 模型，并建立了与 `User` 模型的关联。
    - **后端接口**: 创建了 `/api/upload` 路由，负责处理文件上传。该接口能验证用户会话、解析 `multipart/form-data` 请求、将文件流存入 Vercel Blob，并最终将文件元数据写入数据库。

2.  **前端界面实现**

    - **上传页面**: 创建了 `/documents/upload` 页面，集成了 Uppy `Dashboard` 组件，并实现了组件的中文化。
    - **文件列表**: 创建了 `/documents` 主页面，用于展示所有已上传的文件列表。

3.  **本地开发环境调试**

    - **pnpm 与 Prisma 集成**: 通过在 `package.json` 中配置 `pnpm.onlyBuiltDependencies`，解决了 `pnpm` 包管理器在本地环境下不执行 Prisma `postinstall` 脚本导致模块无法找到的根本问题。
    - **Uppy 依赖补全**: 修复了因缺少 `@uppy/drag-drop`, `@uppy/file-input`, `@uppy/progress-bar` 等多个对等依赖（Peer Dependency）而导致的组件渲染失败问题。
    - **Vercel Blob 认证**: 明确了本地开发时，必须在 `.env.local` 文件中提供从 Vercel 获取的 `BLOB_READ_WRITE_TOKEN` 环境变量，以解决"No token found"的认证错误。

4.  **Vercel 部署流程打通**
    - **Git 仓库初始化**: 完成了本地项目的 Git 初始化，并成功将代码推送至远程 GitHub 仓库。
    - **首次部署尝试**: 成功在 Vercel 上创建了项目，并打通了从 `git push` 到触发 Vercel 自动部署的持续集成（CI/CD）流程。

### 当前状态与后续计划

- **当前状态**: 我们已经解决了所有本地开发和代码层面的问题。但在首次部署到 Vercel 时，遇到了一个新的 **构建时错误**。
- **根本原因**: Vercel 的构建缓存机制导致了 Prisma Client 过期，需要在构建命令中强制执行 `prisma generate`。

- **后续计划**:
  1.  **修复 Vercel 构建脚本**:
      - **目标**: 解决 Vercel 的 Prisma Client 初始化错误。
      - **执行**: 修改 `package.json` 文件，将 `scripts` 中的 `"build"` 命令从 `"next build"` 改为 `"prisma generate && next build"`。
  2.  **完成云端配置**:
      - **目标**: 将修复后的代码推送到 GitHub，等待 Vercel 成功部署，并最终完成云端资源的关联。
      - **执行**:
        - `git push` 推送代码。
        - 在 Vercel 存储页面，将 `shadow-file` 这个 Blob Store 与 `shadow` 项目**关联 (Connect Project)**。
        - 从 Vercel 项目设置中复制 `BLOB_READ_WRITE_TOKEN`。
  3.  **完成本地配置与最终测试**:
      - **目标**: 让本地开发环境能够成功上传文件。
      - **执行**:
        - 将复制的 Token 添加到本地的 `.env.local` 文件中。
        - 重启本地服务 (`pnpm dev`)，测试文件上传功能，确保文件能成功上传并显示在文档列表页。

---

## 角色系统（已归档）

此阶段的目标是建立一个稳定、安全且可扩展的用户角色与权限系统，并完成与前端的初步对接... (细节已省略)
